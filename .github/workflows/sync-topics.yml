name: Sync Repository Topics

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - work
    paths:
      - .github/topics.json
      - .github/workflows/sync-topics.yml

permissions:
  contents: read
  administration: write

jobs:
  sync-topics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync topics from .github/topics.json
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = '.github/topics.json';
            const raw = fs.readFileSync(path, 'utf8');
            const config = JSON.parse(raw);

            if (!Array.isArray(config.topics) || config.topics.length === 0) {
              core.setFailed('topics.json must contain a non-empty "topics" array.');
              return;
            }

            const normalized = [...new Set(config.topics.map((t) => String(t).trim().toLowerCase()).filter(Boolean))];

            await github.request('PUT /repos/{owner}/{repo}/topics', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              names: normalized,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

            core.info(`Synced ${normalized.length} topics: ${normalized.join(', ')}`);
